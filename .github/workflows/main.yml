name: Deploy to Linode VM

on:
  push:
    branches:
      - main

env:
  VM_IP_ADDRESS: ${{ secrets.VM_IP_ADDRESS }}
  VM_USERNAME: ${{ secrets.VM_USERNAME }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PROJECT_NAME: full-stack-project-blueprint

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Copy files to Linode
      uses: appleboy/scp-action@master
      with:
        host: ${{ env.VM_IP_ADDRESS }}
        username: ${{ env.VM_USERNAME }}
        key: ${{ env.SSH_PRIVATE_KEY }}
        source: "."
        target: "/srv/${{ env.PROJECT_NAME }}"

    - name: Deploy on Linode
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.VM_IP_ADDRESS }}
        username: ${{ env.VM_USERNAME }}
        key: ${{ env.SSH_PRIVATE_KEY }}
        script: |
          VM_PATH="/srv/${{ env.PROJECT_NAME }}"
          cd $VM_PATH
          git clone https://github.com/georgy-kirilov/full-stack-project-blueprint.git repo
          cd repo
          git pull origin main
          docker-compose -f $VM_PATH/deploy/docker-compose.yml build
          docker-compose -f $VM_PATH/deploy/docker-compose.yml down
          docker-compose -f $VM_PATH/deploy/docker-compose.yml up -d
